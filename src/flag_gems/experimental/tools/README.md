# Experimental Operators Import Tools

æœ¬ç›®å½•åŒ…å«ç”¨äºæ‰¹é‡å¯¼å…¥è‡ªåŠ¨ç”Ÿæˆç®—å­åˆ° FlagGems experimental æ¡†æ¶çš„å·¥å…·é›†ã€‚

## ğŸ“š æ–‡æ¡£

- **[WORKFLOW.md](WORKFLOW.md)** - å®Œæ•´å·¥ä½œæµç¨‹æŒ‡å—
- **[DATA_FORMAT.md](DATA_FORMAT.md)** - æ•°æ®æ ¼å¼è¯´æ˜
- **README.md** (æœ¬æ–‡ä»¶) - å·¥å…·é›†æ¦‚è§ˆ

## ğŸ› ï¸ å·¥å…·åˆ—è¡¨

### 1. validate_data.py - æ•°æ®éªŒè¯å·¥å…·

éªŒè¯æ€§èƒ½æ•°æ®æ ¼å¼æ˜¯å¦ç¬¦åˆè¦æ±‚ã€‚

**ä½¿ç”¨åœºæ™¯**: åœ¨å¼€å§‹ç­›é€‰ä¹‹å‰ï¼Œå…ˆéªŒè¯æ•°æ®æ ¼å¼

**ç”¨æ³•**:
```bash
# éªŒè¯ä½ çš„æ•°æ®
python validate_data.py --your-data your_perf.json

# éªŒè¯ä½ çš„æ•°æ®å’Œ FlagGems æ•°æ®
python validate_data.py \
    --your-data your_perf.json \
    --flaggems-data flaggems_perf.json
```

**è¾“å‡º**:
- âœ… æ•°æ®æ ¼å¼æ£€æŸ¥ç»“æœ
- âš ï¸ è­¦å‘Šä¿¡æ¯ï¼ˆå¦‚æœ‰ï¼‰
- âŒ é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœ‰ï¼‰
- ğŸ“Š æ•°æ®ç»Ÿè®¡ï¼ˆç®—å­æ•°é‡ã€é…ç½®æ•°é‡ã€åŒ¹é…æƒ…å†µï¼‰

---

### 2. filter_ops.py - ç®—å­ç­›é€‰å·¥å…·

æ ¹æ®æ€§èƒ½æ ‡å‡†ç­›é€‰ç¬¦åˆæ¡ä»¶çš„ç®—å­ã€‚

**ä½¿ç”¨åœºæ™¯**: ä»æ€§èƒ½æ•°æ®ä¸­ç­›é€‰å‡ºè¾¾æ ‡çš„ç®—å­

**ç”¨æ³•**:
```bash
# Batch 1: ç­›é€‰æ¯” FlagGems å¿« â‰¥30% çš„ç®—å­
python filter_ops.py \
    --batch 1 \
    --your-data your_perf.json \
    --flaggems-data flaggems_perf.json \
    --output selected_batch1.json

# Batch 2: ç­›é€‰è¾¾åˆ° CUDA æ€§èƒ½ â‰¥80% çš„æ–°ç®—å­
python filter_ops.py \
    --batch 2 \
    --your-data your_perf.json \
    --output selected_batch2.json
```

**è¾“å‡º**:
- JSON æ–‡ä»¶åŒ…å«ç­›é€‰ç»“æœ
- æ¯ä¸ªç®—å­çš„æ€§èƒ½æŒ‡æ ‡
- ç­›é€‰ç»Ÿè®¡ä¿¡æ¯

---

### 3. batch_import.py - æ‰¹é‡å¯¼å…¥å·¥å…·

æ‰¹é‡å¯¼å…¥ç­›é€‰åçš„ç®—å­åˆ° experimental æ¡†æ¶ã€‚

**ä½¿ç”¨åœºæ™¯**: å°†ç­›é€‰å‡ºçš„ç®—å­å¯¼å…¥åˆ°ä»£ç åº“

**ç”¨æ³•**:
```bash
# é¢„è§ˆï¼ˆä¸å®é™…ä¿®æ”¹æ–‡ä»¶ï¼‰
python batch_import.py \
    --input selected_batch1.json \
    --batch 1 \
    --dry-run

# å®é™…å¯¼å…¥
python batch_import.py \
    --input selected_batch1.json \
    --batch 1
```

**è¾“å‡º**:
- ç”Ÿæˆç®—å­å®ç°æ–‡ä»¶
- ç”Ÿæˆæµ‹è¯•æ–‡ä»¶
- æ›´æ–°å…ƒæ•°æ®
- æ›´æ–° `__init__.py`

---

### 4. import_from_json.py - å•ä¸ªç®—å­å¯¼å…¥å·¥å…·

å¯¼å…¥å•ä¸ªç®—å­ï¼ˆå·²å­˜åœ¨çš„å·¥å…·ï¼‰ã€‚

**ä½¿ç”¨åœºæ™¯**: å¯¼å…¥å•ä¸ªç®—å­æˆ–æ‰‹åŠ¨å¯¼å…¥

**ç”¨æ³•**:
```bash
# å¯¼å…¥å•ä¸ªç®—å­
python import_from_json.py operator.json

# æŒ‡å®šåˆ†ç±»
python import_from_json.py operator.json --category pointwise

# é¢„è§ˆ
python import_from_json.py operator.json --dry-run
```

---

## ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. å‡†å¤‡æ€§èƒ½æ•°æ®      â”‚
â”‚  your_perf.json     â”‚
â”‚  flaggems_perf.json â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. éªŒè¯æ•°æ®æ ¼å¼      â”‚
â”‚  validate_data.py   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. ç­›é€‰ç¬¦åˆæ¡ä»¶     â”‚
â”‚  filter_ops.py      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. å‡†å¤‡ç®—å­ä»£ç      â”‚
â”‚  (JSON with code)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. æ‰¹é‡å¯¼å…¥         â”‚
â”‚  batch_import.py    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. æµ‹è¯•å’ŒéªŒè¯       â”‚
â”‚  pytest             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

è¯¦ç»†æ­¥éª¤è¯·å‚è€ƒ [WORKFLOW.md](WORKFLOW.md)

---

## ğŸ“‹ å¿«é€Ÿå¼€å§‹

### æœ€å°ç¤ºä¾‹

å‡è®¾ä½ å·²ç»å‡†å¤‡å¥½äº†æ€§èƒ½æ•°æ®ï¼š

```bash
# Step 1: éªŒè¯æ•°æ®
python src/flag_gems/experimental/tools/validate_data.py \
    --your-data data/your_perf.json \
    --flaggems-data data/flaggems_perf.json

# Step 2: ç­›é€‰ç®—å­ï¼ˆBatch 1ï¼‰
python src/flag_gems/experimental/tools/filter_ops.py \
    --batch 1 \
    --your-data data/your_perf.json \
    --flaggems-data data/flaggems_perf.json \
    --output results/selected_batch1.json

# Step 3: æ£€æŸ¥ç­›é€‰ç»“æœ
cat results/selected_batch1.json | jq '.'

# Step 4: å‡†å¤‡ç®—å­å®Œæ•´ä»£ç 
# ï¼ˆå‚è€ƒ DATA_FORMAT.md å‡†å¤‡æ¯ä¸ªç®—å­çš„ JSON æ–‡ä»¶ï¼‰

# Step 5: é¢„è§ˆå¯¼å…¥
python src/flag_gems/experimental/tools/batch_import.py \
    --input results/selected_batch1.json \
    --batch 1 \
    --dry-run

# Step 6: å®é™…å¯¼å…¥
python src/flag_gems/experimental/tools/batch_import.py \
    --input results/selected_batch1.json \
    --batch 1

# Step 7: è¿è¡Œæµ‹è¯•
pytest src/flag_gems/experimental/tests/ -v
```

---

## ğŸ¯ ç­›é€‰æ ‡å‡†æ€»ç»“

### Batch 1: ä¼˜åŒ–ç°æœ‰ç®—å­
- **æ ‡å‡†**: ä½ çš„å®ç°ç›¸æ¯” FlagGems åŠ é€Ÿ â‰¥ 30%
- **è®¡ç®—**: `speedup = flaggems_time / your_time â‰¥ 1.30`
- **æ•°æ®éœ€æ±‚**:
  - ä½ çš„ç®—å­ vs CUDA
  - FlagGems ç®—å­ vs CUDA

### Batch 2: æ–°å¢ç®—å­
- **æ ‡å‡†**: ä½ çš„å®ç°è¾¾åˆ° CUDA æ€§èƒ½çš„ â‰¥ 80%
- **è®¡ç®—**: `relative = your_time / cuda_time â‰¤ 1.25`
- **æ•°æ®éœ€æ±‚**:
  - ä½ çš„ç®—å­ vs CUDA

---

## ğŸ“Š ç¤ºä¾‹æ•°æ®æ ¼å¼

### æ€§èƒ½æ•°æ® (your_perf.json)

```json
{
  "gelu": {
    "configs": [
      {
        "shape": [256, 256],
        "dtype": "float32",
        "your_time": 0.5,
        "cuda_time": 1.0
      }
    ]
  }
}
```

### ç®—å­å®Œæ•´æ•°æ® (gelu.json)

```json
{
  "op_name": "aten::gelu",
  "code": "import torch\n...",
  "test_func": "def test_gelu():\n...",
  "params": {},
  "info": {
    "total": 10,
    "success": 10,
    "failed": 0
  }
}
```

è¯¦ç»†æ ¼å¼è¯´æ˜è¯·å‚è€ƒ [DATA_FORMAT.md](DATA_FORMAT.md)

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### é‡è¦é™åˆ¶

1. **æ•°æ®åŒ¹é…**: `filter_ops.py` è¦æ±‚ä½ çš„æ•°æ®å’Œ FlagGems æ•°æ®ä¸­çš„ shape/dtype å®Œå…¨åŒ¹é…æ‰èƒ½è®¡ç®—ç›¸å¯¹åŠ é€Ÿæ¯”

2. **ä»£ç å®Œæ•´æ€§**: `batch_import.py` éœ€è¦æ¯ä¸ªç®—å­çš„å®Œæ•´å®ç°ä»£ç ï¼ˆ`code` å­—æ®µï¼‰å’Œæµ‹è¯•ä»£ç ï¼ˆ`test_func` å­—æ®µï¼‰

3. **å½“å‰ç‰ˆæœ¬çš„ batch_import.py éœ€è¦ä¿®æ”¹**:
   - ç›®å‰ç”Ÿæˆçš„æ˜¯å ä½ç¬¦ä»£ç 
   - ä½ éœ€è¦æä¾›å®é™…çš„ç®—å­å®ç°
   - æˆ–è€…ä¿®æ”¹è„šæœ¬ä»¥é€‚é…ä½ çš„ä»£ç å­˜å‚¨æ ¼å¼

### å»ºè®®

1. å…ˆè¿è¡Œ `validate_data.py` ç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®
2. ä½¿ç”¨ `--dry-run` å‚æ•°é¢„è§ˆå¯¼å…¥ç»“æœ
3. å°æ‰¹é‡æµ‹è¯•ï¼Œç¡®è®¤æµç¨‹æ­£ç¡®åå†å¤§æ‰¹é‡å¯¼å…¥
4. æ¯æ¬¡å¯¼å…¥åè¿è¡Œæµ‹è¯•éªŒè¯

---

## ğŸ› æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

**Q1: filter_ops.py ç­›é€‰ç»“æœä¸ºç©ºï¼Ÿ**

A: æ£€æŸ¥ä½ çš„æ•°æ®å’Œ FlagGems æ•°æ®ä¸­çš„é…ç½®æ˜¯å¦åŒ¹é…ï¼ˆshape, dtypeï¼‰

**Q2: batch_import.py æŠ¥é”™ "TODO: Add actual implementation"ï¼Ÿ**

A: éœ€è¦ä¿®æ”¹è„šæœ¬ä»¥åŠ è½½ä½ çš„å®é™…ç®—å­ä»£ç ï¼Œæˆ–æä¾›æ ‡å‡†æ ¼å¼çš„ JSON æ–‡ä»¶

**Q3: æµ‹è¯•å¤±è´¥ï¼Ÿ**

A: æ£€æŸ¥ç®—å­å®ç°æ˜¯å¦æ­£ç¡®ï¼Œä½¿ç”¨ `pytest -v -s` æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯

æ›´å¤šé—®é¢˜è¯·å‚è€ƒ [WORKFLOW.md](WORKFLOW.md) çš„æ•…éšœæ’æŸ¥ç« èŠ‚

---

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœ‰é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹ [WORKFLOW.md](WORKFLOW.md) å’Œ [DATA_FORMAT.md](DATA_FORMAT.md)
2. æ£€æŸ¥å·¥å…·è¾“å‡ºçš„é”™è¯¯å’Œè­¦å‘Šä¿¡æ¯
3. è¿è¡Œå¸¦ `-v` å‚æ•°æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
4. åœ¨ GitHub ä¸Šæ Issue

---

## ğŸ”„ æ›´æ–°æ—¥å¿—

- **2025-12-20**: åˆ›å»ºå·¥å…·é›†
  - æ•°æ®éªŒè¯å·¥å…·
  - ç®—å­ç­›é€‰å·¥å…·
  - æ‰¹é‡å¯¼å…¥å·¥å…·
  - å®Œæ•´æ–‡æ¡£

---

**Enjoy importing! ğŸš€**
